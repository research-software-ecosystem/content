name: 'validate bio.tools json and auto-merge'

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'data/**/*.biotools.json'

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: checkout contents repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: set branch name
        run: echo "BRANCH_NAME=${{ github.head_ref }}" >> $GITHUB_ENV        

      - name: get tool ID from branch name
        id: vars
        shell: bash
        run: |
          TOOL_ID="${BRANCH_NAME#*__}"  # Extract after '__'
          FILE="data/$TOOL_ID/$TOOL_ID.biotools.json"
          echo "tool_id=$TOOL_ID" >> "$GITHUB_OUTPUT"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: verify TOOL_ID is all lowercase
        shell: bash
        run: |
          if [[ "${{ steps.vars.outputs.tool_id }}" =~ [A-Z] ]]; then
            echo "❌ Error: TOOL_ID ('${{ steps.vars.outputs.tool_id }}') must be all lowercase."
            exit 1
          fi

      - name: reformat json to a predictable format with jq (no sponge)
        if: ${{ !endsWith(github.head_ref, '__delete') }}
        shell: bash
        run: |
          tmpfile=$(mktemp)
          trap 'rm -f "$tmpfile"' EXIT ERR
          jq --indent 4 'walk( if type == "array" then sort else . end )' "${{ steps.vars.outputs.file }}" > "$tmpfile"
          mv "$tmpfile" "${{ steps.vars.outputs.file }}"
          echo "✅ Processed ${{ steps.vars.outputs.file }}!"

      - uses: stefanzweifel/git-auto-commit-action@v6
        id: commit
        with:
          commit_message: "reformat json with jq"
          commit_user_name: Tools Platform Ecosystem bot
          commit_user_email: tpe-bot@github.com
          commit_author: Tools Platform Ecosystem bot <tpe-bot@github.com>
          branch: ${{ env.BRANCH_NAME }}
          file_pattern: ${{ steps.vars.outputs.file }}
      
      - name: Merge PR branch into main
        run: |
          git config --local user.email "tpe-bot@github.com"
          git config --local user.name "Tools Platform Ecosystem bot"
          git fetch origin master
          git checkout master
          git merge --no-ff "${GITHUB_HEAD_REF}" -m "Auto-merge PR #${{ github.event.pull_request.number }}"
          git push origin master
          echo "✅ Pull request #${{ github.event.pull_request.number }} merged!"
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: delete source branch after merge
        # Uses the GitHub CLI to delete the branch after merge
        env:
          GITHUB_TOKEN: "${{ secrets.REPO_TOKEN }}"
        run: |
          if [[ -z "${BRANCH_NAME}" ]]; then
            echo "⚪ Branch name is missing, skipping delete."
            exit 0
          fi
          echo "⏳ Deleting branch ${BRANCH_NAME} from the repository..."
          if gh api -X DELETE "/repos/${{ github.repository }}/git/refs/heads/${BRANCH_NAME}"; then
            echo "✅ Branch ${BRANCH_NAME} deleted."
          else
            echo "❌ Failed to delete branch ${BRANCH_NAME}."
            exit 1
          fi
